#+STARTUP: fold
#+TITLE: RNN with pytorch
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session torch :kernel torch

* Notebook Settings
#+begin_src ipython
  %load_ext autoreload
  %autoreload 2
  %reload_ext autoreload

  %run ../notebooks/setup.py
  %matplotlib inline
  %config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
: The autoreload extension is already loaded. To reload it, use:
:   %reload_ext autoreload
: Python exe
: /home/leon/mambaforge/envs/torch/bin/python

* Helpers
** Data
#+begin_src ipython
  def get_rates_ini_phi(name, ini_list, phi_list):
    rates_list = []
    for ini in ini_list:
      for phi in phi_list:
        rates = np.load(REPO_ROOT + '/data/simul/%s_ini_%d_phi_%d.npy' % (name, ini, phi))
        rates_list.append(rates)

    rates_list = np.array(rates_list).reshape(len(ini_list), len(phi_list), rates.shape[0], rates.shape[1])
    print(rates_list.shape)
    return rates_list  
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_df_ini_phi(rates):
      n_trials, n_phi, n_times, n_neurons = rates.shape

      # Create indices
      trials_ind, phi_ind, times_ind, neurons_ind = np.indices((n_trials, n_phi, n_times, n_neurons))

      # Construct DataFrame
      df = pd.DataFrame({
          'trial': trials_ind.flatten(),
          'phi': phi_ind.flatten(),
          'neuron': neurons_ind.flatten(),
          'time': times_ind.flatten(),
          'rates': rates.flatten()
      })

      return df

#+end_src

#+RESULTS:

#+begin_src ipython
  def load_data_ini_phi(name, ini_list, phi_list):
      rates = get_rates_ini_phi(name, ini_list, phi_list)
      df = get_df_ini_phi(rates)
      return df
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_code_ini_phi(df):
      df_code = df.groupby(['time', 'trial', 'phi'] )['rates'].apply(decode_bump).reset_index()
      df_code[['m0', 'm1', 'phase']] = pd.DataFrame(df_code['rates'].tolist(), index=df_code.index)
      df_code = df_code.drop(columns=['rates'])

      end_point = df_code[df_code.time==df_code.time.iloc[-1]]
      end_point = end_point.drop(columns=['time'])
      print(end_point.head())  
      return df_code, end_point  
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_precision(x):
      return x - circmean(x)
#+end_src

#+RESULTS:

** Simul

#+begin_src ipython
  import subprocess

  def gpu_memory_usage_percentage():
      total_mem_str = subprocess.check_output(["nvidia-smi", "--query-gpu=memory.total", "--format=csv,nounits,noheader"])
      used_mem_str = subprocess.check_output(["nvidia-smi", "--query-gpu=memory.used", "--format=csv,nounits,noheader"])
      
      total_mem_list = map(float, total_mem_str.decode('utf-8').strip().split('\n'))
      used_mem_list = map(float, used_mem_str.decode('utf-8').strip().split('\n'))

      mem_percentage_list = [(used_mem / total_mem) * 100.0 for total_mem, used_mem in zip(total_mem_list, used_mem_list)]

      return np.array(mem_percentage_list)

  memory_percentages = gpu_memory_usage_percentage()

  # The memory usage for each GPU is indexed from 0
  for index, percentage in enumerate(memory_percentages):
      print(f'GPU {index} Memory Usage: {percentage:.2f}%')

#+end_src

#+RESULTS:
: GPU 0 Memory Usage: 19.80%
: GPU 1 Memory Usage: 0.09%

#+begin_src ipython
  from time import sleep

  def check_gpu(device):
      memory_percentages = gpu_memory_usage_percentage()
      if device == 'cuda:0':
          if memory_percentages[0] > 75:
              while memory_percentages[1] > 75:
                  memory_percentages = gpu_memory_usage_percentage()
                  sleep(10)
              else:
                  device='cuda:1'
      else:
          if memory_percentages[1] > 75:
              while memory_percentages[0] > 75:
                  memory_percentages = gpu_memory_usage_percentage()
                  sleep(10)
              else:
                  device='cuda:0'
                  
      return device
#+end_src

#+RESULTS:

#+begin_src ipython
  device = check_gpu('cuda:0')
  print(device)
#+end_src

#+RESULTS:
: cuda:0

#+begin_src ipython
  # import multiprocessing
  # if multiprocessing.get_start_method(allow_none=True) != 'spawn':
  #   multiprocessing.set_start_method('spawn', force=True)
  # from multiprocessing import Process

  def run_ini_phi(name, ini_list, phi_list):
      LOAD_MAT = 0
      SAVE_MAT = 1

      device = 'cuda:0'

      df_list = []
      for ini in ini_list:
          for phi in phi_list:

              print('##########################################')
              print("trial", ini, "phi", phi)
              print('##########################################')

              model = Network('config_bump.yml', '%s_ini_%d_phi_%d' % (name, ini, phi),
                              REPO_ROOT, LOAD_MAT=LOAD_MAT, SAVE_MAT=SAVE_MAT, DEVICE=device)

              model.run()
              # process = Process(target=model.run)
              # process.start()
              # process.join()
              device = check_gpu(device)
              
              LOAD_MAT = 1
              SAVE_MAT = 0
#+end_src

#+RESULTS:

* RNN with torch
** Imports
#+begin_src ipython
  import sys
  sys.path.insert(0, '../')

  import pandas as pd

  from src.network import Network
  from src.plot_utils import plot_con
#+end_src

#+RESULTS:
** Single Trial
*** Model
#+begin_src ipython
  REPO_ROOT = "/home/leon/models/NeuroTorch"
  model = Network('config_bump.yml', 'bump', REPO_ROOT, VERBOSE=1, DEVICE='cuda')
#+end_src

#+RESULTS:
: Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
: Na tensor([1000], dtype=torch.int32) Ka tensor([1.]) csumNa tensor([   0, 1000])
: DT 0.001 TAU [0.02]
: Jab [-2.75]
: Ja0 [14.0]
: All to all connectivity 
: with heterogeneity, SIGMA tensor(1.)
: with strong cosine structure, KAPPA tensor(0.4000)

*** Simulation
#+begin_src ipython
  rates = model.run()
#+end_src

#+RESULTS:
#+begin_example
  times (s) 0.5 rates (Hz) [2.17]
  STIM ON
  times (s) 1.0 rates (Hz) [2.78]
  STIM OFF
  times (s) 1.5 rates (Hz) [6.23]
  times (s) 2.0 rates (Hz) [5.88]
  times (s) 2.5 rates (Hz) [5.9]
  times (s) 3.0 rates (Hz) [5.88]
  times (s) 3.5 rates (Hz) [5.89]
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump.npy
  Elapsed (with compilation) = 2.4400144000537694s
#+end_example

*** Analysis
#+begin_src ipython
  # plt.plot(rates.T)
  # plt.show()
#+end_src

#+RESULTS:

#+begin_src ipython
  plt.imshow(rates.T, aspect='auto', cmap='jet', vmin=0, vmax=10)
  plt.colorbar()
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/2c4b5bf7fd9af32666bc316dc135a8c33b038fc1.png]]


#+begin_src ipython

#+end_src

#+RESULTS:

*** Connectivity
#+begin_src ipython
  print(model.Wab[0][0])
#+end_src

#+RESULTS:
: Linear(in_features=1000, out_features=1000, bias=True)

#+begin_src ipython
  Cij = model.Wab[0][0].weight.data.cpu().detach().numpy()
  plot_con(Cij)
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/8e340de2655a58d6ba75f1b54b33bde5734b2e8b.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Multiple Trials
*** Parameters
#+begin_src ipython
  REPO_ROOT = "/home/leon/models/NeuroTorch"
  ini_list = np.arange(0, 100)
  # phi_list = np.linspace(0, 315, 8)
  phi_list = [180]
#+end_src

#+RESULTS:

*** Simulation
#+begin_src ipython
  name = 'bump'
  run_ini_phi(name, ini_list, phi_list)
#+end_src

#+RESULTS:
#+begin_example
  ##########################################
  trial 0 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_0_phi_180.npy
  Elapsed (with compilation) = 2.873816854786128s
  ##########################################
  trial 1 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_1_phi_180.npy
  Elapsed (with compilation) = 2.6806319979950786s
  ##########################################
  trial 2 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_2_phi_180.npy
  Elapsed (with compilation) = 2.6940402793698013s
  ##########################################
  trial 3 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_3_phi_180.npy
  Elapsed (with compilation) = 2.6942031867802143s
  ##########################################
  trial 4 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_4_phi_180.npy
  Elapsed (with compilation) = 2.6746996180154383s
  ##########################################
  trial 5 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_5_phi_180.npy
  Elapsed (with compilation) = 2.6786076556891203s
  ##########################################
  trial 6 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_6_phi_180.npy
  Elapsed (with compilation) = 2.741953083779663s
  ##########################################
  trial 7 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_7_phi_180.npy
  Elapsed (with compilation) = 2.725590730085969s
  ##########################################
  trial 8 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_8_phi_180.npy
  Elapsed (with compilation) = 2.697480166796595s
  ##########################################
  trial 9 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_9_phi_180.npy
  Elapsed (with compilation) = 2.7045909226872027s
  ##########################################
  trial 10 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_10_phi_180.npy
  Elapsed (with compilation) = 2.6916559231467545s
  ##########################################
  trial 11 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_11_phi_180.npy
  Elapsed (with compilation) = 2.6962011847645044s
  ##########################################
  trial 12 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_12_phi_180.npy
  Elapsed (with compilation) = 2.6943361116573215s
  ##########################################
  trial 13 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_13_phi_180.npy
  Elapsed (with compilation) = 2.7021161690354347s
  ##########################################
  trial 14 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_14_phi_180.npy
  Elapsed (with compilation) = 2.694578202906996s
  ##########################################
  trial 15 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_15_phi_180.npy
  Elapsed (with compilation) = 2.6959502822719514s
  ##########################################
  trial 16 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_16_phi_180.npy
  Elapsed (with compilation) = 2.8086879472248256s
  ##########################################
  trial 17 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_17_phi_180.npy
  Elapsed (with compilation) = 2.686288776807487s
  ##########################################
  trial 18 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_18_phi_180.npy
  Elapsed (with compilation) = 2.671218245755881s
  ##########################################
  trial 19 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_19_phi_180.npy
  Elapsed (with compilation) = 2.692257140763104s
  ##########################################
  trial 20 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_20_phi_180.npy
  Elapsed (with compilation) = 2.6952381739392877s
  ##########################################
  trial 21 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_21_phi_180.npy
  Elapsed (with compilation) = 2.6839871178381145s
  ##########################################
  trial 22 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_22_phi_180.npy
  Elapsed (with compilation) = 2.7080431166104972s
  ##########################################
  trial 23 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_23_phi_180.npy
  Elapsed (with compilation) = 2.6995910741388798s
  ##########################################
  trial 24 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_24_phi_180.npy
  Elapsed (with compilation) = 2.752051080111414s
  ##########################################
  trial 25 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_25_phi_180.npy
  Elapsed (with compilation) = 2.7596800290048122s
  ##########################################
  trial 26 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_26_phi_180.npy
  Elapsed (with compilation) = 2.705320928711444s
  ##########################################
  trial 27 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_27_phi_180.npy
  Elapsed (with compilation) = 2.716669274959713s
  ##########################################
  trial 28 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_28_phi_180.npy
  Elapsed (with compilation) = 2.7011409499682486s
  ##########################################
  trial 29 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_29_phi_180.npy
  Elapsed (with compilation) = 2.6895743058994412s
  ##########################################
  trial 30 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_30_phi_180.npy
  Elapsed (with compilation) = 2.6915193521417677s
  ##########################################
  trial 31 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_31_phi_180.npy
  Elapsed (with compilation) = 2.6957844658754766s
  ##########################################
  trial 32 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_32_phi_180.npy
  Elapsed (with compilation) = 2.6916430853307247s
  ##########################################
  trial 33 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_33_phi_180.npy
  Elapsed (with compilation) = 2.701472402084619s
  ##########################################
  trial 34 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_34_phi_180.npy
  Elapsed (with compilation) = 2.700798638164997s
  ##########################################
  trial 35 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_35_phi_180.npy
  Elapsed (with compilation) = 2.695869208779186s
  ##########################################
  trial 36 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_36_phi_180.npy
  Elapsed (with compilation) = 2.6959694591350853s
  ##########################################
  trial 37 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_37_phi_180.npy
  Elapsed (with compilation) = 2.823653227649629s
  ##########################################
  trial 38 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_38_phi_180.npy
  Elapsed (with compilation) = 2.7395790880545974s
  ##########################################
  trial 39 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_39_phi_180.npy
  Elapsed (with compilation) = 2.7454336751252413s
  ##########################################
  trial 40 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_40_phi_180.npy
  Elapsed (with compilation) = 2.744693889748305s
  ##########################################
  trial 41 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_41_phi_180.npy
  Elapsed (with compilation) = 2.8066602228209376s
  ##########################################
  trial 42 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_42_phi_180.npy
  Elapsed (with compilation) = 2.7820915998890996s
  ##########################################
  trial 43 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_43_phi_180.npy
  Elapsed (with compilation) = 2.758694542106241s
  ##########################################
  trial 44 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_44_phi_180.npy
  Elapsed (with compilation) = 2.7521237451583147s
  ##########################################
  trial 45 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_45_phi_180.npy
  Elapsed (with compilation) = 2.7687263409607112s
  ##########################################
  trial 46 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_46_phi_180.npy
  Elapsed (with compilation) = 2.748189790174365s
  ##########################################
  trial 47 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_47_phi_180.npy
  Elapsed (with compilation) = 2.7517239530570805s
  ##########################################
  trial 48 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_48_phi_180.npy
  Elapsed (with compilation) = 2.75723038893193s
  ##########################################
  trial 49 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_49_phi_180.npy
  Elapsed (with compilation) = 2.7548169060610235s
  ##########################################
  trial 50 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_50_phi_180.npy
  Elapsed (with compilation) = 2.7651517633348703s
  ##########################################
  trial 51 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_51_phi_180.npy
  Elapsed (with compilation) = 2.77033006073907s
  ##########################################
  trial 52 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_52_phi_180.npy
  Elapsed (with compilation) = 2.763389578089118s
  ##########################################
  trial 53 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_53_phi_180.npy
  Elapsed (with compilation) = 2.77311330800876s
  ##########################################
  trial 54 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_54_phi_180.npy
  Elapsed (with compilation) = 2.7475473070517182s
  ##########################################
  trial 55 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_55_phi_180.npy
  Elapsed (with compilation) = 2.7661822382360697s
  ##########################################
  trial 56 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_56_phi_180.npy
  Elapsed (with compilation) = 2.7664966261945665s
  ##########################################
  trial 57 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_57_phi_180.npy
  Elapsed (with compilation) = 2.7770135840401053s
  ##########################################
  trial 58 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_58_phi_180.npy
  Elapsed (with compilation) = 2.863223441876471s
  ##########################################
  trial 59 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_59_phi_180.npy
  Elapsed (with compilation) = 2.795375057030469s
  ##########################################
  trial 60 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_60_phi_180.npy
  Elapsed (with compilation) = 2.7946665287017822s
  ##########################################
  trial 61 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_61_phi_180.npy
  Elapsed (with compilation) = 2.780960012227297s
  ##########################################
  trial 62 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_62_phi_180.npy
  Elapsed (with compilation) = 2.766195075120777s
  ##########################################
  trial 63 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_63_phi_180.npy
  Elapsed (with compilation) = 2.773118060082197s
  ##########################################
  trial 64 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_64_phi_180.npy
  Elapsed (with compilation) = 2.84796336106956s
  ##########################################
  trial 65 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_65_phi_180.npy
  Elapsed (with compilation) = 2.8060770402662456s
  ##########################################
  trial 66 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_66_phi_180.npy
  Elapsed (with compilation) = 2.8021222366951406s
  ##########################################
  trial 67 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_67_phi_180.npy
  Elapsed (with compilation) = 2.8072183993645012s
  ##########################################
  trial 68 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_68_phi_180.npy
  Elapsed (with compilation) = 2.798194605857134s
  ##########################################
  trial 69 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_69_phi_180.npy
  Elapsed (with compilation) = 2.7810431262478232s
  ##########################################
  trial 70 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_70_phi_180.npy
  Elapsed (with compilation) = 2.7612211578525603s
  ##########################################
  trial 71 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_71_phi_180.npy
  Elapsed (with compilation) = 2.771902756765485s
  ##########################################
  trial 72 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_72_phi_180.npy
  Elapsed (with compilation) = 2.7725231889635324s
  ##########################################
  trial 73 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_73_phi_180.npy
  Elapsed (with compilation) = 2.8531936649233103s
  ##########################################
  trial 74 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_74_phi_180.npy
  Elapsed (with compilation) = 2.8072319142520428s
  ##########################################
  trial 75 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_75_phi_180.npy
  Elapsed (with compilation) = 2.7901776554062963s
  ##########################################
  trial 76 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_76_phi_180.npy
  Elapsed (with compilation) = 2.793387681245804s
  ##########################################
  trial 77 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_77_phi_180.npy
  Elapsed (with compilation) = 2.7942901621572673s
  ##########################################
  trial 78 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_78_phi_180.npy
  Elapsed (with compilation) = 2.797396041918546s
  ##########################################
  trial 79 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_79_phi_180.npy
  Elapsed (with compilation) = 2.803597674239427s
  ##########################################
  trial 80 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_80_phi_180.npy
  Elapsed (with compilation) = 2.7992770401760936s
  ##########################################
  trial 81 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_81_phi_180.npy
  Elapsed (with compilation) = 2.8060483927838504s
  ##########################################
  trial 82 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_82_phi_180.npy
  Elapsed (with compilation) = 2.8076242469251156s
  ##########################################
  trial 83 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_83_phi_180.npy
  Elapsed (with compilation) = 2.8432615250349045s
  ##########################################
  trial 84 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_84_phi_180.npy
  Elapsed (with compilation) = 2.8583952677436173s
  ##########################################
  trial 85 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_85_phi_180.npy
  Elapsed (with compilation) = 2.8634611209854484s
  ##########################################
  trial 86 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_86_phi_180.npy
  Elapsed (with compilation) = 2.8677812330424786s
  ##########################################
  trial 87 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_87_phi_180.npy
  Elapsed (with compilation) = 2.900425362866372s
  ##########################################
  trial 88 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_88_phi_180.npy
  Elapsed (with compilation) = 2.9068364538252354s
  ##########################################
  trial 89 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_89_phi_180.npy
  Elapsed (with compilation) = 2.8853444922715425s
  ##########################################
  trial 90 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_90_phi_180.npy
  Elapsed (with compilation) = 2.8594421772286296s
  ##########################################
  trial 91 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_91_phi_180.npy
  Elapsed (with compilation) = 2.869904856197536s
  ##########################################
  trial 92 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_92_phi_180.npy
  Elapsed (with compilation) = 2.8676886968314648s
  ##########################################
  trial 93 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_93_phi_180.npy
  Elapsed (with compilation) = 2.859925887081772s
  ##########################################
  trial 94 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_94_phi_180.npy
  Elapsed (with compilation) = 2.8515986120328307s
  ##########################################
  trial 95 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_95_phi_180.npy
  Elapsed (with compilation) = 2.8514064899645746s
  ##########################################
  trial 96 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_96_phi_180.npy
  Elapsed (with compilation) = 2.8550376379862428s
  ##########################################
  trial 97 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_97_phi_180.npy
  Elapsed (with compilation) = 2.8534561758860946s
  ##########################################
  trial 98 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_98_phi_180.npy
  Elapsed (with compilation) = 2.854195720050484s
  ##########################################
  trial 99 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump_ini_99_phi_180.npy
  Elapsed (with compilation) = 2.8536150911822915s
#+end_example

*** Load data

#+begin_src ipython
  df = load_data_ini_phi('bump', ini_list, phi_list)
  print(df.head())
#+end_src

#+RESULTS:
: (100, 1, 3999, 1000)
:    trial  phi  neuron  time     rates
: 0      0    0       0     0  1.984009
: 1      0    0       1     0  2.118548
: 2      0    0       2     0  2.709407
: 3      0    0       3     0  2.501559
: 4      0    0       4     0  2.384525

#+begin_src ipython
  df_code, end_point = get_code_ini_phi(df)
#+end_src

#+RESULTS:
:         trial  phi        m0        m1     phase
: 399800      0    0  5.894755  5.324325  3.081275
: 399801      1    0  5.877878  5.347837  3.093784
: 399802      2    0  5.893431  5.513807  2.869461
: 399803      3    0  5.898397  5.493224  3.104073
: 399804      4    0  5.864051  5.438927  3.155159

#+begin_src ipython
  fig, ax = plt.subplots(1, 2, figsize=[2*width, height])

  # sns.lineplot(end_point, x='Ie', y='m0', ax=ax[0], legend=False, marker='o')
  sns.lineplot(df_code, x='time', y=df_code['phase']*180/np.pi, ax=ax[0], legend=False, hue='trial', lw=2, alpha=0.2)
  ax[0].set_xlabel('Time (s)')
  ax[0].set_ylabel('Phase (°)')

  sns.histplot(data=end_point, x=end_point['phase']*180/np.pi,kde=False, bins='auto', stat='density', color='b')
  ax[1].set_xlabel('Time (s)')
  ax[1].set_ylabel('Phase (°)')

  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/a696dc007cf814f1251bc70bb024b676ecd67d89.png]]

#+begin_src ipython
  end_point['accuracy'] = (end_point.phase - end_point['phi'] * np.pi / 180) % (2 * np.pi)
  end_point['precision'] = end_point.groupby(['phi'], group_keys=False)['phase'].apply(get_precision)
 
  print(end_point.head())
#+end_src

#+RESULTS:
:         trial  phi        m0        m1     phase  accuracy  precision
: 399800      0    0  5.894755  5.324325  3.081275  3.081275  -0.055621
: 399801      1    0  5.877878  5.347837  3.093784  3.093784  -0.043112
: 399802      2    0  5.893431  5.513807  2.869461  2.869461  -0.267435
: 399803      3    0  5.898397  5.493224  3.104073  3.104073  -0.032823
: 399804      4    0  5.864051  5.438927  3.155159  3.155159   0.018263

#+begin_src ipython
  fig, ax = plt.subplots(1, 3, figsize=[2*width, height])

  sns.histplot(data=point, x=point['phase']*180/np.pi, legend=False, lw=2, ax=ax[0], kde=False, bins=200, stat='density', color='b')
  sns.histplot(data=point_on, x=point_on['phase']*180/np.pi, legend=False, lw=2, ax=ax[0], kde=False, bins=200, stat='density', color='r')
  ax[0].set_xlabel('$\phi$(°)')
  ax[0].set_ylabel('Density')
  ax[0].set_xticks([0, 90, 180, 270, 360])

  sns.histplot(data=point, x=point['accuracy']*180/np.pi, legend=False, lw=2, ax=ax[1], kde=False, bins=200, stat='density', color='b')
  sns.histplot(data=point_on, x=point_on['accuracy']*180/np.pi, legend=False, lw=2, ax=ax[1], kde=False, bins=200, stat='density', color='r')
  ax[1].set_xlabel('$\phi - \phi_{stim}$ (°)')
  ax[1].set_ylabel('Density')
  ax[1].set_xticks([0, 90, 180, 270, 360])

  sns.histplot(data=point, x=point['precision']*180/np.pi, legend=False, ax=ax[2], bins='auto', kde=True, stat='density', element='step', alpha=0,color = 'b')
  sns.histplot(data=point_on, x=point_on['precision']*180/np.pi, legend=False, ax=ax[2], bins='auto', kde=True, stat='density', element='step', alpha=0., color='r')
  ax[2].set_xlabel('$\phi - <\phi>_{trials}$ (°)')
  ax[2].set_ylabel('Density')
  ax[2].set_xlim([-20, 20])

  plt.show()  
#+end_src

* Test
#+begin_src ipython
  import torch
  import torch.nn as nn

  class MyModel(nn.Module):
      def __init__(self, hidden_size, noise_stddev, device='cpu'):
          super(MyModel, self).__init__()
          self.hidden_size = hidden_size
          self.noise_stddev = noise_stddev
          self.device = device
          self.fc = nn.Linear(self.hidden_size, self.hidden_size, device=self.device)  # example layer

      def forward(self, h):
          noise = torch.randn_like(h, device=self.device) * self.noise_stddev
          h = self.fc(h + noise)
          return h

      def run(self):
          result = []
          h = torch.zeros(self.hidden_size, device=self.device)

          for t in range(10):
              h = self.forward(h)
              result.append(h.cpu().detach().numpy())
          return result
#+end_src

#+RESULTS:

#+begin_src ipython
  model = MyModel(100, 10)
  result = model.run()
#+end_src

#+RESULTS:

#+begin_src ipython
  result = np.array(result)
  print(result.shape)
  plt.plot(result.T)
#+end_src

#+RESULTS:
:RESULTS:
: (10, 100)
| <matplotlib.lines.Line2D | at | 0x7fc75e911780> | <matplotlib.lines.Line2D | at | 0x7fc75e9117b0> | <matplotlib.lines.Line2D | at | 0x7fc75e9118a0> | <matplotlib.lines.Line2D | at | 0x7fc75e911990> | <matplotlib.lines.Line2D | at | 0x7fc75e911a80> | <matplotlib.lines.Line2D | at | 0x7fc75e911b70> | <matplotlib.lines.Line2D | at | 0x7fc75e911c60> | <matplotlib.lines.Line2D | at | 0x7fc75e911d50> | <matplotlib.lines.Line2D | at | 0x7fc75e911e40> | <matplotlib.lines.Line2D | at | 0x7fc75e911f30> |
[[file:./.ob-jupyter/b00d8e86d22ddfbba28e6614acf5496369fd722b.png]]
:END:

