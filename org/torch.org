#+STARTUP: fold
#+TITLE: RNN with pytorch
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session torch :kernel torch

* Notebook Settings

#+begin_src ipython
  %load_ext autoreload
  %autoreload 2
  %reload_ext autoreload

  %run ../notebooks/setup.py
  %matplotlib inline
  %config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
: The autoreload extension is already loaded. To reload it, use:
:   %reload_ext autoreload
: Python exe
: /home/leon/mambaforge/envs/torch/bin/python

* Helpers
** Data
#+begin_src ipython
  def get_rates_ini_phi(name, ini_list, phi_list):
    rates_list = []
    for ini in ini_list:
      for phi in phi_list:
        rates = np.load(REPO_ROOT + '/data/simul/%s_ini_%d_phi_%d.npy' % (name, ini, phi))
        rates_list.append(rates)

    rates_list = np.array(rates_list).reshape(len(ini_list), len(phi_list), rates.shape[0], rates.shape[1])
    print(rates_list.shape)
    return rates_list  
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_df_ini_phi(rates):
      n_trials, n_phi, n_times, n_neurons = rates.shape

      # Create indices
      trials_ind, phi_ind, times_ind, neurons_ind = np.indices((n_trials, n_phi, n_times, n_neurons))

      # Construct DataFrame
      df = pd.DataFrame({
          'trial': trials_ind.flatten(),
          'phi': phi_ind.flatten(),
          'neuron': neurons_ind.flatten(),
          'time': times_ind.flatten(),
          'rates': rates.flatten()
      })

      return df

#+end_src

#+RESULTS:

#+begin_src ipython
  def load_data_ini_phi(name, ini_list, phi_list):
      rates = get_rates_ini_phi(name, ini_list, phi_list)
      df = get_df_ini_phi(rates)
      return df
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_code_ini_phi(df):
      df_code = df.groupby(['time', 'trial', 'phi'] )['rates'].apply(decode_bump).reset_index()
      df_code[['m0', 'm1', 'phase']] = pd.DataFrame(df_code['rates'].tolist(), index=df_code.index)
      df_code = df_code.drop(columns=['rates'])

      end_point = df_code[df_code.time==df_code.time.iloc[-1]]
      end_point = end_point.drop(columns=['time'])
      print(end_point.head())  
      return df_code, end_point  
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_precision(x):
      return x - circmean(x)
#+end_src

#+RESULTS:

** Simul

#+begin_src ipython
  import subprocess

  def gpu_memory_usage_percentage():
      total_mem_str = subprocess.check_output(["nvidia-smi", "--query-gpu=memory.total", "--format=csv,nounits,noheader"])
      used_mem_str = subprocess.check_output(["nvidia-smi", "--query-gpu=memory.used", "--format=csv,nounits,noheader"])
      
      total_mem_list = map(float, total_mem_str.decode('utf-8').strip().split('\n'))
      used_mem_list = map(float, used_mem_str.decode('utf-8').strip().split('\n'))

      mem_percentage_list = [(used_mem / total_mem) * 100.0 for total_mem, used_mem in zip(total_mem_list, used_mem_list)]

      return np.array(mem_percentage_list)

  memory_percentages = gpu_memory_usage_percentage()

  # The memory usage for each GPU is indexed from 0
  for index, percentage in enumerate(memory_percentages):
      print(f'GPU {index} Memory Usage: {percentage:.2f}%')

#+end_src

#+RESULTS:
: GPU 0 Memory Usage: 0.07%
: GPU 1 Memory Usage: 0.07%

#+begin_src ipython
  from time import sleep

  def check_gpu(device):
      memory_percentages = gpu_memory_usage_percentage()
      if device == 'cuda:0':
          if memory_percentages[0] > 75:
              while memory_percentages[1] > 75:
                  memory_percentages = gpu_memory_usage_percentage()
                  sleep(10)
              else:
                  device='cuda:1'
      else:
          if memory_percentages[1] > 75:
              while memory_percentages[0] > 75:
                  memory_percentages = gpu_memory_usage_percentage()
                  sleep(10)
              else:
                  device='cuda:0'
                  
      return device
#+end_src

#+RESULTS:

#+begin_src ipython
  device = check_gpu('cuda:0')
  print(device)
#+end_src

#+RESULTS:
: cuda:0

#+begin_src ipython
  # import multiprocessing
  # if multiprocessing.get_start_method(allow_none=True) != 'spawn':
  #   multiprocessing.set_start_method('spawn', force=True)
  # from multiprocessing import Process

  def run_ini_phi(name, ini_list, phi_list):
      LOAD_MAT = 0
      SAVE_MAT = 1

      device = 'cuda:0'

      df_list = []
      for ini in ini_list:
          for phi in phi_list:

              print('##########################################')
              print("trial", ini, "phi", phi)
              print('##########################################')

              model = Network('config_bump.yml', '%s_ini_%d_phi_%d' % (name, ini, phi),
                              REPO_ROOT, LOAD_MAT=LOAD_MAT, SAVE_MAT=SAVE_MAT, DEVICE=device, PHI0=phi)
              
              model.run()
              # process = Process(target=model.run)
              # process.start()
              # process.join()
              device = check_gpu(device)

              LOAD_MAT = 1
              SAVE_MAT = 0
#+end_src

#+RESULTS:

* RNN with torch
** Imports
#+begin_src ipython
  import sys
  sys.path.insert(0, '../')

  import pandas as pd

  from src.network import Network
  from src.plot_utils import plot_con
  from src.decode import decode_bump
#+end_src

#+RESULTS:
** Single Trial
*** Model
#+begin_src ipython
  REPO_ROOT = "/home/leon/models/NeuroTorch"
  model = Network('config_EI.yml', 'bump', REPO_ROOT, VERBOSE=1, DEVICE='cuda')
#+end_src

#+RESULTS:
#+begin_example
  Loading config from /home/leon/models/NeuroTorch/conf/config_EI.yml
  Na tensor([7500, 2500], dtype=torch.int32) Ka tensor([500., 500.], dtype=torch.float64) csumNa tensor([    0,  7500, 10000])
  DT 0.001 TAU [0.02, 0.02]
  Jab [1.0, -1.5, 1, -1]
  Ja0 [0.5, 0.25]
  ksi torch.Size([4, 7500])
  Pij torch.Size([7500])
  Sparse random connectivity 
  with weak low rank structure, KAPPA 30.00
  Sparse random connectivity 
  Sparse random connectivity 
  Sparse random connectivity 
#+end_example

*** Simulation
#+begin_src ipython
  rates = model.run()
#+end_src

#+RESULTS:
#+begin_example
  times (s) 0.25 rates (Hz) [0.32, 0.57]
  times (s) 0.5 rates (Hz) [0.32, 0.57]
  times (s) 0.75 rates (Hz) [0.33, 0.57]
  STIM ON
  times (s) 1.0 rates (Hz) [0.74, 0.57]
  times (s) 1.25 rates (Hz) [2.1, 2.44]
  STIM OFF
  times (s) 1.5 rates (Hz) [2.0, 2.44]
  times (s) 1.75 rates (Hz) [0.33, 0.57]
  times (s) 2.0 rates (Hz) [0.32, 0.57]
  times (s) 2.25 rates (Hz) [0.32, 0.57]
  times (s) 2.5 rates (Hz) [0.33, 0.57]
  times (s) 2.75 rates (Hz) [0.33, 0.57]
  times (s) 3.0 rates (Hz) [0.33, 0.57]
  times (s) 3.25 rates (Hz) [0.32, 0.57]
  times (s) 3.5 rates (Hz) [0.33, 0.57]
  times (s) 3.75 rates (Hz) [0.33, 0.57]
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/bump.npy
  Elapsed (with compilation) = 6.701421577017754s
#+end_example

*** Analysis
#+begin_src ipython
  # plt.plot(rates.T)
  # plt.show()
#+end_src

#+RESULTS:

#+begin_src ipython
  plt.imshow(rates.T, aspect='auto', cmap='jet', vmin=0, vmax=1)
  plt.colorbar()
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/114fa9d753100f1a7b9a82dd59e99a0f01289fe8.png]]


#+begin_src ipython
ksi = model.ksi.cpu().detach().numpy()
#+end_src

#+RESULTS:

#+begin_src ipython
  theta = np.arctan2(ksi[1], ksi[0])
#+end_src

#+RESULTS:

#+begin_src ipython
  index_order = theta.argsort()
#+end_src

#+RESULTS:

#+begin_src ipython
  rates_ordered = rates[:, index_order]
#+end_src

#+RESULTS:

#+begin_src ipython
  plt.imshow(rates_ordered.T, aspect='auto', cmap='jet', vmin=0, vmax=1)
  plt.colorbar()
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/ab60edce609e06e128beecd336c2fddc31484e16.png]]

*** Connectivity
#+begin_src ipython
  print(model.Wab[0][0])
#+end_src

#+RESULTS:
: Linear(in_features=7500, out_features=7500, bias=True)

#+begin_src ipython
  Cij = model.Wab[0][0].weight.data.cpu().detach().numpy()
  plot_con(Cij)
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/a06c01797875423dd562fe5dd670d3e147140d99.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Multiple Trials
*** Parameters
#+begin_src ipython
  REPO_ROOT = "/home/leon/models/NeuroTorch"
  ini_list = np.arange(50, 100)
  # phi_list = np.linspace(0, 315, 8)
  phi_list = [0, 180]
#+end_src

#+RESULTS:

*** Simulation
#+begin_src ipython
  name = 'heter_10'
  run_ini_phi(name, ini_list, phi_list)
#+end_src

#+RESULTS:
#+begin_example
  ##########################################
  trial 50 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_50_phi_0.npy
  Elapsed (with compilation) = 4.904687044967432s
  ##########################################
  trial 50 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_50_phi_180.npy
  Elapsed (with compilation) = 5.018479595019016s
  ##########################################
  trial 51 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_51_phi_0.npy
  Elapsed (with compilation) = 5.007457468949724s
  ##########################################
  trial 51 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_51_phi_180.npy
  Elapsed (with compilation) = 5.017675707989838s
  ##########################################
  trial 52 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_52_phi_0.npy
  Elapsed (with compilation) = 5.0213888339931145s
  ##########################################
  trial 52 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_52_phi_180.npy
  Elapsed (with compilation) = 5.1969269050168805s
  ##########################################
  trial 53 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_53_phi_0.npy
  Elapsed (with compilation) = 5.045028174994513s
  ##########################################
  trial 53 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_53_phi_180.npy
  Elapsed (with compilation) = 5.05052375496598s
  ##########################################
  trial 54 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_54_phi_0.npy
  Elapsed (with compilation) = 5.041752686025575s
  ##########################################
  trial 54 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_54_phi_180.npy
  Elapsed (with compilation) = 5.062134482024703s
  ##########################################
  trial 55 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_55_phi_0.npy
  Elapsed (with compilation) = 5.0446767209796235s
  ##########################################
  trial 55 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_55_phi_180.npy
  Elapsed (with compilation) = 5.033042035007384s
  ##########################################
  trial 56 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_56_phi_0.npy
  Elapsed (with compilation) = 5.046883909031749s
  ##########################################
  trial 56 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_56_phi_180.npy
  Elapsed (with compilation) = 5.043284334009513s
  ##########################################
  trial 57 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_57_phi_0.npy
  Elapsed (with compilation) = 5.052160078950692s
  ##########################################
  trial 57 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_57_phi_180.npy
  Elapsed (with compilation) = 5.034135702997446s
  ##########################################
  trial 58 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_58_phi_0.npy
  Elapsed (with compilation) = 5.050077047024388s
  ##########################################
  trial 58 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_58_phi_180.npy
  Elapsed (with compilation) = 5.195644002989866s
  ##########################################
  trial 59 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_59_phi_0.npy
  Elapsed (with compilation) = 5.099700799968559s
  ##########################################
  trial 59 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_59_phi_180.npy
  Elapsed (with compilation) = 5.087620576028712s
  ##########################################
  trial 60 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_60_phi_0.npy
  Elapsed (with compilation) = 5.0924467199947685s
  ##########################################
  trial 60 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_60_phi_180.npy
  Elapsed (with compilation) = 5.084484144987073s
  ##########################################
  trial 61 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_61_phi_0.npy
  Elapsed (with compilation) = 5.088748264010064s
  ##########################################
  trial 61 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_61_phi_180.npy
  Elapsed (with compilation) = 5.125067949993536s
  ##########################################
  trial 62 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_62_phi_0.npy
  Elapsed (with compilation) = 5.05817960598506s
  ##########################################
  trial 62 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_62_phi_180.npy
  Elapsed (with compilation) = 5.055738031980582s
  ##########################################
  trial 63 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_63_phi_0.npy
  Elapsed (with compilation) = 5.056828144995961s
  ##########################################
  trial 63 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_63_phi_180.npy
  Elapsed (with compilation) = 5.067211529996712s
  ##########################################
  trial 64 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_64_phi_0.npy
  Elapsed (with compilation) = 5.086077057989314s
  ##########################################
  trial 64 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_64_phi_180.npy
  Elapsed (with compilation) = 5.083968596998602s
  ##########################################
  trial 65 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_65_phi_0.npy
  Elapsed (with compilation) = 5.246729302976746s
  ##########################################
  trial 65 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_65_phi_180.npy
  Elapsed (with compilation) = 5.124633530038409s
  ##########################################
  trial 66 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_66_phi_0.npy
  Elapsed (with compilation) = 5.1214505399693735s
  ##########################################
  trial 66 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_66_phi_180.npy
  Elapsed (with compilation) = 5.13321233401075s
  ##########################################
  trial 67 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_67_phi_0.npy
  Elapsed (with compilation) = 5.122824108053464s
  ##########################################
  trial 67 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_67_phi_180.npy
  Elapsed (with compilation) = 5.116815105022397s
  ##########################################
  trial 68 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_68_phi_0.npy
  Elapsed (with compilation) = 5.119822603999637s
  ##########################################
  trial 68 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_68_phi_180.npy
  Elapsed (with compilation) = 5.103439497004729s
  ##########################################
  trial 69 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_69_phi_0.npy
  Elapsed (with compilation) = 5.1151458420208655s
  ##########################################
  trial 69 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_69_phi_180.npy
  Elapsed (with compilation) = 5.094397115986794s
  ##########################################
  trial 70 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_70_phi_0.npy
  Elapsed (with compilation) = 5.0929383970214985s
  ##########################################
  trial 70 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_70_phi_180.npy
  Elapsed (with compilation) = 5.11976108700037s
  ##########################################
  trial 71 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_71_phi_0.npy
  Elapsed (with compilation) = 5.256737692980096s
  ##########################################
  trial 71 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_71_phi_180.npy
  Elapsed (with compilation) = 5.1688495929702185s
  ##########################################
  trial 72 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_72_phi_0.npy
  Elapsed (with compilation) = 5.117125642020255s
  ##########################################
  trial 72 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_72_phi_180.npy
  Elapsed (with compilation) = 5.106474457017612s
  ##########################################
  trial 73 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_73_phi_0.npy
  Elapsed (with compilation) = 5.1200740819913335s
  ##########################################
  trial 73 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_73_phi_180.npy
  Elapsed (with compilation) = 5.116215056972578s
  ##########################################
  trial 74 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_74_phi_0.npy
  Elapsed (with compilation) = 5.096099152986426s
  ##########################################
  trial 74 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_74_phi_180.npy
  Elapsed (with compilation) = 5.094965861993842s
  ##########################################
  trial 75 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_75_phi_0.npy
  Elapsed (with compilation) = 5.097166688996367s
  ##########################################
  trial 75 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_75_phi_180.npy
  Elapsed (with compilation) = 5.117222240020055s
  ##########################################
  trial 76 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_76_phi_0.npy
  Elapsed (with compilation) = 5.092142731999047s
  ##########################################
  trial 76 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_76_phi_180.npy
  Elapsed (with compilation) = 5.117394075030461s
  ##########################################
  trial 77 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_77_phi_0.npy
  Elapsed (with compilation) = 5.118042139976751s
  ##########################################
  trial 77 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_77_phi_180.npy
  Elapsed (with compilation) = 5.328656953992322s
  ##########################################
  trial 78 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_78_phi_0.npy
  Elapsed (with compilation) = 5.151012132992037s
  ##########################################
  trial 78 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_78_phi_180.npy
  Elapsed (with compilation) = 5.146664369967766s
  ##########################################
  trial 79 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_79_phi_0.npy
  Elapsed (with compilation) = 5.1427345629781485s
  ##########################################
  trial 79 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_79_phi_180.npy
  Elapsed (with compilation) = 5.143196387041826s
  ##########################################
  trial 80 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_80_phi_0.npy
  Elapsed (with compilation) = 5.144163321994711s
  ##########################################
  trial 80 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_80_phi_180.npy
  Elapsed (with compilation) = 5.136117133952212s
  ##########################################
  trial 81 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_81_phi_0.npy
  Elapsed (with compilation) = 5.129715225950349s
  ##########################################
  trial 81 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_81_phi_180.npy
  Elapsed (with compilation) = 5.134909096988849s
  ##########################################
  trial 82 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_82_phi_0.npy
  Elapsed (with compilation) = 5.139835943991784s
  ##########################################
  trial 82 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_82_phi_180.npy
  Elapsed (with compilation) = 5.15054758801125s
  ##########################################
  trial 83 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_83_phi_0.npy
  Elapsed (with compilation) = 5.1350881879916415s
  ##########################################
  trial 83 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_83_phi_180.npy
  Elapsed (with compilation) = 5.289667690987699s
  ##########################################
  trial 84 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_84_phi_0.npy
  Elapsed (with compilation) = 5.180889742972795s
  ##########################################
  trial 84 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_84_phi_180.npy
  Elapsed (with compilation) = 5.184511315950658s
  ##########################################
  trial 85 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_85_phi_0.npy
  Elapsed (with compilation) = 5.178829807031434s
  ##########################################
  trial 85 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_85_phi_180.npy
  Elapsed (with compilation) = 5.205059081024956s
  ##########################################
  trial 86 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_86_phi_0.npy
  Elapsed (with compilation) = 5.200746036018245s
  ##########################################
  trial 86 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_86_phi_180.npy
  Elapsed (with compilation) = 5.193135123001412s
  ##########################################
  trial 87 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_87_phi_0.npy
  Elapsed (with compilation) = 5.166930629988201s
  ##########################################
  trial 87 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_87_phi_180.npy
  Elapsed (with compilation) = 5.177359408000484s
  ##########################################
  trial 88 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_88_phi_0.npy
  Elapsed (with compilation) = 5.170978103007656s
  ##########################################
  trial 88 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_88_phi_180.npy
  Elapsed (with compilation) = 5.18364769598702s
  ##########################################
  trial 89 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_89_phi_0.npy
  Elapsed (with compilation) = 5.171939144027419s
  ##########################################
  trial 89 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_89_phi_180.npy
  Elapsed (with compilation) = 5.337349836016074s
  ##########################################
  trial 90 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_90_phi_0.npy
  Elapsed (with compilation) = 5.238337964983657s
  ##########################################
  trial 90 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_90_phi_180.npy
  Elapsed (with compilation) = 5.221032974019181s
  ##########################################
  trial 91 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_91_phi_0.npy
  Elapsed (with compilation) = 5.250491643964779s
  ##########################################
  trial 91 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_91_phi_180.npy
  Elapsed (with compilation) = 5.222226718033198s
  ##########################################
  trial 92 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_92_phi_0.npy
  Elapsed (with compilation) = 5.211929338052869s
  ##########################################
  trial 92 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_92_phi_180.npy
  Elapsed (with compilation) = 5.213452687021345s
  ##########################################
  trial 93 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_93_phi_0.npy
  Elapsed (with compilation) = 5.204253607953433s
  ##########################################
  trial 93 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_93_phi_180.npy
  Elapsed (with compilation) = 5.217227515007835s
  ##########################################
  trial 94 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_94_phi_0.npy
  Elapsed (with compilation) = 5.202922192984261s
  ##########################################
  trial 94 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_94_phi_180.npy
  Elapsed (with compilation) = 5.2308417549938895s
  ##########################################
  trial 95 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_95_phi_0.npy
  Elapsed (with compilation) = 5.208571505965665s
  ##########################################
  trial 95 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_95_phi_180.npy
  Elapsed (with compilation) = 5.379498106020037s
  ##########################################
  trial 96 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_96_phi_0.npy
  Elapsed (with compilation) = 5.252985297003761s
  ##########################################
  trial 96 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_96_phi_180.npy
  Elapsed (with compilation) = 5.2683746999828145s
  ##########################################
  trial 97 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_97_phi_0.npy
  Elapsed (with compilation) = 5.264918425993528s
  ##########################################
  trial 97 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_97_phi_180.npy
  Elapsed (with compilation) = 5.2527264060336165s
  ##########################################
  trial 98 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_98_phi_0.npy
  Elapsed (with compilation) = 5.264051953039598s
  ##########################################
  trial 98 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_98_phi_180.npy
  Elapsed (with compilation) = 5.250807532982435s
  ##########################################
  trial 99 phi 0
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_99_phi_0.npy
  Elapsed (with compilation) = 5.214587850961834s
  ##########################################
  trial 99 phi 180
  ##########################################
  Loading config from /home/leon/models/NeuroTorch/conf/config_bump.yml
  Saving rates to: /home/leon/models/NeuroTorch/data/simul/heter_10_ini_99_phi_180.npy
  Elapsed (with compilation) = 5.236180087027606s
#+end_example

*** Load data

#+begin_src ipython
  df = load_data_ini_phi(name, ini_list, phi_list)
  print(df.head())
#+end_src

#+RESULTS:
: (10, 2, 8499, 1000)
:    trial  phi  neuron  time     rates
: 0      0    0       0     0  2.067906
: 1      0    0       1     0  1.407572
: 2      0    0       2     0  0.757654
: 3      0    0       3     0  2.879726
: 4      0    0       4     0  1.694464

#+begin_src ipython
  df_code, end_point = get_code_ini_phi(df)
#+end_src

#+RESULTS:
:         trial  phi        m0        m1     phase
: 799600      0    0  5.839283  5.427488  3.238797
: 799601      0    1  5.895799  5.625913  3.096245
: 799602      1    0  5.884342  5.503954  3.253456
: 799603      1    1  5.881776  5.473856  3.386259
: 799604      2    0  5.889124  5.463150  3.138596

#+begin_src ipython
  fig, ax = plt.subplots(1, 2, figsize=[2*width, height])

  # sns.lineplot(end_point, x='Ie', y='m0', ax=ax[0], legend=False, marker='o')
  sns.lineplot(df_code, x='time', y=df_code['phase']*180/np.pi, ax=ax[0], legend=False, hue='trial', lw=2, alpha=0.2)
  ax[0].set_xlabel('Time (s)')
  ax[0].set_ylabel('Phase (°)')

  sns.histplot(data=end_point, x=end_point['phase']*180/np.pi,kde=False, bins='auto', stat='density', color='b')
  ax[1].set_xlabel('Time (s)')
  ax[1].set_ylabel('Phase (°)')

  plt.show()
#+end_src

#+RESULTS:
: b4307798-c921-4b0a-8d75-8f5215d593ef

#+begin_src ipython
  end_point['accuracy'] = (end_point.phase - end_point['phi'] * np.pi / 180) % (2 * np.pi)
  end_point['precision'] = end_point.groupby(['phi'], group_keys=False)['phase'].apply(get_precision)
 
  print(end_point.head())
#+end_src

#+RESULTS:
:         trial  phi        m0        m1     phase  accuracy  precision
: 399800      0    0  5.894755  5.324325  3.081275  3.081275  -0.055621
: 399801      1    0  5.877878  5.347837  3.093784  3.093784  -0.043112
: 399802      2    0  5.893431  5.513807  2.869461  2.869461  -0.267435
: 399803      3    0  5.898397  5.493224  3.104073  3.104073  -0.032823
: 399804      4    0  5.864051  5.438927  3.155159  3.155159   0.018263

#+begin_src ipython
  fig, ax = plt.subplots(1, 3, figsize=[2*width, height])

  sns.histplot(data=point, x=point['phase']*180/np.pi, legend=False, lw=2, ax=ax[0], kde=False, bins=200, stat='density', color='b')
  sns.histplot(data=point_on, x=point_on['phase']*180/np.pi, legend=False, lw=2, ax=ax[0], kde=False, bins=200, stat='density', color='r')
  ax[0].set_xlabel('$\phi$(°)')
  ax[0].set_ylabel('Density')
  ax[0].set_xticks([0, 90, 180, 270, 360])

  sns.histplot(data=point, x=point['accuracy']*180/np.pi, legend=False, lw=2, ax=ax[1], kde=False, bins=200, stat='density', color='b')
  sns.histplot(data=point_on, x=point_on['accuracy']*180/np.pi, legend=False, lw=2, ax=ax[1], kde=False, bins=200, stat='density', color='r')
  ax[1].set_xlabel('$\phi - \phi_{stim}$ (°)')
  ax[1].set_ylabel('Density')
  ax[1].set_xticks([0, 90, 180, 270, 360])

  sns.histplot(data=point, x=point['precision']*180/np.pi, legend=False, ax=ax[2], bins='auto', kde=True, stat='density', element='step', alpha=0,color = 'b')
  sns.histplot(data=point_on, x=point_on['precision']*180/np.pi, legend=False, ax=ax[2], bins='auto', kde=True, stat='density', element='step', alpha=0., color='r')
  ax[2].set_xlabel('$\phi - <\phi>_{trials}$ (°)')
  ax[2].set_ylabel('Density')
  ax[2].set_xlim([-20, 20])

  plt.show()  
#+end_src

* Test
#+begin_src ipython
  import torch
  import torch.nn as nn

  class MyModel(nn.Module):
      def __init__(self, hidden_size, noise_stddev, device='cpu'):
          super(MyModel, self).__init__()
          self.hidden_size = hidden_size
          self.noise_stddev = noise_stddev
          self.device = device
          self.fc = nn.Linear(self.hidden_size, self.hidden_size, device=self.device)  # example layer

      def forward(self, h):
          noise = torch.randn_like(h, device=self.device) * self.noise_stddev
          h = self.fc(h + noise)
          return h

      def run(self):
          result = []
          h = torch.zeros(self.hidden_size, device=self.device)

          for t in range(10):
              h = self.forward(h)
              result.append(h.cpu().detach().numpy())
          return result
#+end_src

#+RESULTS:

#+begin_src ipython
  model = MyModel(100, 10)
  result = model.run()
#+end_src

#+RESULTS:

#+begin_src ipython
  result = np.array(result)
  print(result.shape)
  plt.plot(result.T)
#+end_src

#+RESULTS:
:RESULTS:
: (10, 100)
| <matplotlib.lines.Line2D | at | 0x7fc75e911780> | <matplotlib.lines.Line2D | at | 0x7fc75e9117b0> | <matplotlib.lines.Line2D | at | 0x7fc75e9118a0> | <matplotlib.lines.Line2D | at | 0x7fc75e911990> | <matplotlib.lines.Line2D | at | 0x7fc75e911a80> | <matplotlib.lines.Line2D | at | 0x7fc75e911b70> | <matplotlib.lines.Line2D | at | 0x7fc75e911c60> | <matplotlib.lines.Line2D | at | 0x7fc75e911d50> | <matplotlib.lines.Line2D | at | 0x7fc75e911e40> | <matplotlib.lines.Line2D | at | 0x7fc75e911f30> |
[[file:./.ob-jupyter/b00d8e86d22ddfbba28e6614acf5496369fd722b.png]]
:END:

