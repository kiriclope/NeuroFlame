#+STARTUP: fold
#+TITLE: Learning Continuous Manifolds
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session manifold :kernel torch

* Notebook Settings

#+begin_src ipython
  %load_ext autoreload
  %autoreload 2
  %reload_ext autoreload

  %run ../notebooks/setup.py
  %matplotlib inline
  %config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
:RESULTS:
The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
Python exe
/home/leon/mambaforge/bin/python
:END:

* Imports

#+begin_src ipython
  import sys
  sys.path.insert(0, '../')

  import torch
  import pandas as pd
  from time import perf_counter

  from src.network import Network
  from src.plot_utils import plot_con
  from src.decode import decode_bump
#+end_src

#+RESULTS:

* Helpers
** Connectivity

#+begin_src ipython
  def plot_eigen(W):
      # Compute eigenvalues
      eigenvalues = torch.linalg.eigvals(W).cpu().numpy()

      # Extract real and imaginary parts
      real_parts = eigenvalues.real
      imag_parts = eigenvalues.imag

      # Plotting
      plt.scatter(real_parts, imag_parts)
      plt.xlabel('Real Part')
      plt.ylabel('Imaginary Part')
      plt.axhline(y=0, color='k', linestyle='--')
      plt.axvline(x=0, color='k', linestyle='--')
      
      # plt.grid(True, which='both')
      plt.show()
#+end_src

#+RESULTS:

** Random

#+begin_src ipython
  def convert_seconds(seconds):
      h = seconds // 3600
      m = (seconds % 3600) // 60
      s = seconds % 60
      return h, m, s
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_theta(a, b, GM=0, IF_NORM=0):

      if GM:
          b = b - np.dot(b, a) / np.dot(a, a) * a

      if IF_NORM:
          u = a / np.linalg.norm(a)
          v = b / np.linalg.norm(b)
      else:
          u=a
          v=b

      return np.arctan2(v, u)
#+end_src

#+RESULTS:

#+begin_src ipython
  def normalize(v):
      return v / np.linalg.norm(v)

  def project(x, u):
      return x * u
  # return np.dot(x, u) * u

  def sort_by_angle(x, u, v):
      u_hat = normalize(u)
      v_hat = normalize(v)

      x_proj_u = project(x, u_hat)
      x_proj_v = project(x, v_hat)
      # x_proj = x_proj_u + x_proj_v
      theta = np.arctan2(x_proj_v, x_proj_u) + np.pi

      # cos_theta = np.dot(x_proj, u_hat) / np.linalg.norm(x_proj) * u_hat
      # sin_theta = np.dot(x_proj, v_hat) / np.linalg.norm(x_proj) * v_hat
      # theta = np.arctan2(sin_theta, cos_theta)

      # Pair up each element of x with the corresponding angle
      # x_angle_pairs = list(zip(x, theta))

      # Sort based on the angle
      # x_angle_pairs.sort(key=lambda pair: pair[1])

      # Extract the sorted elements
      # sorted_x = [pair[0] for pair in x_angle_pairs]

      return theta
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_idx(model):
      ksi = model.PHI0.cpu().detach().numpy()
      print(ksi.shape)

      idx = np.arange(0, len(ksi[0]))
      theta = get_theta(ksi[0], ksi[2], GM=0, IF_NORM=0)

      return theta.argsort()
#+end_src

#+RESULTS:

#+begin_src ipython
  def get_overlap(model, rates):
      ksi = model.PHI0.cpu().detach().numpy()
      return rates @ ksi.T / rates.shape[-1]

#+end_src

#+RESULTS:

* Manifolds
** 1 population

#+begin_src ipython
  REPO_ROOT = "/home/leon/models/NeuroTorch"
  model = Network('config_1pop.yml', 'test', REPO_ROOT, VERBOSE=1, DEVICE='cuda:1', LIVE_FF_UPDATE=0, GAIN=2)
#+end_src

#+RESULTS:
:RESULTS:
Na tensor([1000], device='cuda:1', dtype=torch.int32) Ka tensor([1.], device='cuda:1') csumNa tensor([   0, 1000], device='cuda:1')
Jab [1.0]
Ja0 [1.0]
:END:

*** Training

#+begin_src ipython
  theta_list = torch.linspace(0, 2.0 * torch.pi, model.Na[0] + 1)[:-1]

  Wfb = torch.stack((torch.cos(theta_list), torch.sin(theta_list)))
  Wfb = Wfb.to('cuda:1')
  print('Wfb:', Wfb.shape)

  N_TRAIN = 40
  A_psi = 1.2 # / torch.sqrt(model.Ka[0])
  psi_list = torch.linspace(0, 2.0 * torch.pi, N_TRAIN + 1)[:-1]

  z = torch.stack((torch.cos(psi_list), torch.sin(psi_list))).T
  z = A_psi * z.to('cuda:1')

  print('z:', z.shape)

  ff_input = model.Ja0[0] + z @ Wfb
  print('input:', ff_input.shape)
  
  # need to make the input a sequence
  ff_input = ff_input.unsqueeze(1).expand(ff_input.shape[0], model.N_STEPS, ff_input.shape[-1])
  print('reshaped input:', ff_input.shape)
#+end_src

#+RESULTS:
:RESULTS:
Wfb: torch.Size([2, 1000])
z: torch.Size([40, 2])
input: torch.Size([40, 1000])
reshaped input: torch.Size([40, 4440, 1000])
:END:

#+begin_src ipython
  rates = model(ff_input, REC_LAST_ONLY=0)
#+end_src

#+RESULTS:
:RESULTS:
times (s) 0.0 rates (Hz) [0.39]
times (s) 0.09 rates (Hz) [0.39]
times (s) 0.18 rates (Hz) [0.39]
times (s) 0.27 rates (Hz) [0.39]
times (s) 0.36 rates (Hz) [0.39]
times (s) 0.45 rates (Hz) [0.39]
times (s) 0.54 rates (Hz) [0.39]
times (s) 0.63 rates (Hz) [0.39]
times (s) 0.72 rates (Hz) [0.39]
times (s) 0.81 rates (Hz) [0.39]
times (s) 0.9 rates (Hz) [0.39]
times (s) 0.99 rates (Hz) [0.39]
times (s) 1.08 rates (Hz) [0.39]
times (s) 1.17 rates (Hz) [0.39]
times (s) 1.26 rates (Hz) [0.39]
times (s) 1.35 rates (Hz) [0.39]
times (s) 1.44 rates (Hz) [0.39]
times (s) 1.53 rates (Hz) [0.39]
times (s) 1.62 rates (Hz) [0.39]
times (s) 1.71 rates (Hz) [0.39]
times (s) 1.8 rates (Hz) [0.39]
times (s) 1.89 rates (Hz) [0.39]
times (s) 1.98 rates (Hz) [0.39]
times (s) 2.07 rates (Hz) [0.39]
times (s) 2.16 rates (Hz) [0.39]
times (s) 2.25 rates (Hz) [0.39]
times (s) 2.34 rates (Hz) [0.39]
times (s) 2.43 rates (Hz) [0.39]
times (s) 2.52 rates (Hz) [0.39]
times (s) 2.61 rates (Hz) [0.39]
times (s) 2.7 rates (Hz) [0.39]
times (s) 2.79 rates (Hz) [0.39]
times (s) 2.88 rates (Hz) [0.39]
times (s) 2.97 rates (Hz) [0.39]
times (s) 3.06 rates (Hz) [0.39]
times (s) 3.15 rates (Hz) [0.39]
times (s) 3.24 rates (Hz) [0.39]
times (s) 3.33 rates (Hz) [0.39]
times (s) 3.42 rates (Hz) [0.39]
times (s) 3.51 rates (Hz) [0.39]
times (s) 3.6 rates (Hz) [0.39]
times (s) 3.69 rates (Hz) [0.39]
times (s) 3.78 rates (Hz) [0.39]
times (s) 3.87 rates (Hz) [0.39]
times (s) 3.96 rates (Hz) [0.39]
times (s) 4.05 rates (Hz) [0.39]
times (s) 4.14 rates (Hz) [0.39]
times (s) 4.23 rates (Hz) [0.39]
times (s) 4.32 rates (Hz) [0.39]
times (s) 4.41 rates (Hz) [0.39]
times (s) 4.5 rates (Hz) [0.39]
times (s) 4.59 rates (Hz) [0.39]
times (s) 4.68 rates (Hz) [0.39]
times (s) 4.77 rates (Hz) [0.39]
times (s) 4.86 rates (Hz) [0.39]
times (s) 4.95 rates (Hz) [0.39]
times (s) 5.05 rates (Hz) [0.39]
times (s) 5.14 rates (Hz) [0.39]
times (s) 5.23 rates (Hz) [0.39]
times (s) 5.32 rates (Hz) [0.39]
times (s) 5.41 rates (Hz) [0.39]
times (s) 5.5 rates (Hz) [0.39]
times (s) 5.59 rates (Hz) [0.39]
times (s) 5.68 rates (Hz) [0.39]
times (s) 5.77 rates (Hz) [0.39]
times (s) 5.86 rates (Hz) [0.39]
times (s) 5.95 rates (Hz) [0.39]
times (s) 6.04 rates (Hz) [0.39]
times (s) 6.13 rates (Hz) [0.39]
times (s) 6.22 rates (Hz) [0.39]
times (s) 6.31 rates (Hz) [0.39]
times (s) 6.4 rates (Hz) [0.39]
times (s) 6.49 rates (Hz) [0.39]
times (s) 6.58 rates (Hz) [0.39]
times (s) 6.67 rates (Hz) [0.39]
times (s) 6.76 rates (Hz) [0.39]
times (s) 6.85 rates (Hz) [0.39]
times (s) 6.94 rates (Hz) [0.39]
times (s) 7.03 rates (Hz) [0.39]
times (s) 7.12 rates (Hz) [0.39]
times (s) 7.21 rates (Hz) [0.39]
times (s) 7.3 rates (Hz) [0.39]
times (s) 7.39 rates (Hz) [0.39]
times (s) 7.48 rates (Hz) [0.39]
times (s) 7.57 rates (Hz) [0.39]
times (s) 7.66 rates (Hz) [0.39]
times (s) 7.75 rates (Hz) [0.39]
times (s) 7.84 rates (Hz) [0.39]
times (s) 7.93 rates (Hz) [0.39]
times (s) 8.02 rates (Hz) [0.39]
times (s) 8.11 rates (Hz) [0.39]
times (s) 8.2 rates (Hz) [0.39]
times (s) 8.29 rates (Hz) [0.39]
times (s) 8.38 rates (Hz) [0.39]
times (s) 8.47 rates (Hz) [0.39]
times (s) 8.56 rates (Hz) [0.39]
times (s) 8.65 rates (Hz) [0.39]
times (s) 8.74 rates (Hz) [0.39]
times (s) 8.83 rates (Hz) [0.39]
times (s) 8.92 rates (Hz) [0.39]
times (s) 9.01 rates (Hz) [0.39]
Elapsed (with compilation) = 0.5812804996967316s
:END:

#+begin_src ipython
  plt.imshow(rates[-3].cpu().numpy().T, aspect='auto', origin='lower',vmin=0, vmax=2, cmap='jet')
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/6eea5101939506df679053e040584e106729f472.png]]
:END:

#+begin_src ipython
  plt.plot(rates[0,:,:3].cpu().numpy())
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/994d05a18f33e88da0b9d1bfd9e4960585a4c58d.png]]
:END:

#+begin_src ipython
  print(z.shape)
  theta = get_theta(z.T[0].cpu().numpy(), z.T[1].cpu().numpy(), GM=0, IF_NORM=0)
  idx = theta.argsort()
  print(theta.shape)
  rates_ord = rates[..., idx]
  print(rates_ord.shape)
#+end_src

#+RESULTS:
:RESULTS:
torch.Size([40, 2])
(40,)
torch.Size([40, 101, 40])
:END:

#+begin_src ipython
  plt.imshow(rates_ord[0].cpu().numpy().T, aspect='auto', origin='lower', vmax=2, cmap='jet')
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/7acd6ba8f29ea9c8df5d69814eed042b81a147b6.png]]
:END:

#+begin_src ipython
  print('rates:', rates.shape)
#+end_src

#+RESULTS:
:RESULTS:
rates: torch.Size([40, 101, 1000])
:END:

#+begin_src ipython
  # Wout = Phi @ Cinv @ zbar
  # where Phi are the steady state rates phi(theta_i, psi_m) (N x M)
  # Cinv is the correlations btw rates PhiT @ Phi (MxM)

  Phi = rates[:,-1].T
  Corr = Phi.T @ Phi
  print('Phi', Phi.shape, 'Corr', Corr.shape, 'z', z.shape)

  Wout = Phi @ Corr @ z
  print('Wout', Wout.shape)
  
  Wstruct = Wfb.T @ Wout.T
  print('W', Wstruct.shape)
#+end_src

#+RESULTS:
:RESULTS:
Phi torch.Size([1000, 40]) Corr torch.Size([40, 40]) z torch.Size([40, 2])
Wout torch.Size([1000, 2])
W torch.Size([1000, 1000])
:END:

#+begin_src ipython
  # Cij = model.Wab_T.cpu().detach().numpy()
  Cij = Corr.cpu().numpy()
#+end_src

#+RESULTS:

#+begin_src ipython
  plt.figure(figsize=(12, 5))  # Set the figure size (width, height) in inches

  ax1 = plt.subplot2grid((2, 3), (0, 0), rowspan=2)
  im = ax1.imshow(Cij, cmap='jet', aspect=1)
  ax1.set_xlabel("Presynaptic")
  ax1.set_ylabel("Postsynaptic")

  # Second column, first row
  ax2 = plt.subplot2grid((2, 3), (0, 1))
  Kj = np.sum(Cij, axis=0)  # sum over pres
  ax2.plot(Kj)
  # ax2.set_xticklabels([])
  ax2.set_ylabel("$K_j$")

  # # Second column, second row
  ax3 = plt.subplot2grid((2, 3), (1, 1))
  Ki = np.sum(Cij, axis=1)  # sum over pres
  ax3.plot(Kj)
  ax3.set_ylabel("$K_i$")

  ax4 = plt.subplot2grid((2, 3), (0, 2), rowspan=2)
  diags = []
  for i in range(int(Cij.shape[0] / 2)):
      diags.append(np.trace(Cij, offset=i) / Cij.shape[0])
      diags = np.array(diags)
      ax4.plot(diags)
      ax4.set_xlabel("Neuron #")
      ax4.set_ylabel("$P_{ij}$")

  plt.tight_layout()
  plt.show()

#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/1bac12ee2dc42edd75daad56c6a950bd5859cf03.png]]
:END:

*** Testing

#+begin_src ipython
  model.Wab_T[model.slices[0],model.slices[0]].add_(Wstruct.T);
#+end_src

#+RESULTS:

#+begin_src ipython
  model.TASK = 'odr'
  rates = model()
#+end_src

#+RESULTS:
:RESULTS:
Generating ff input
times (s) 0.0 rates (Hz) [0.0]
times (s) 0.09 rates (Hz) [0.0]
times (s) 0.18 rates (Hz) [0.0]
times (s) 0.27 rates (Hz) [0.0]
times (s) 0.36 rates (Hz) [-0.0]
times (s) 0.45 rates (Hz) [0.0]
times (s) 0.54 rates (Hz) [0.0]
times (s) 0.63 rates (Hz) [-0.0]
times (s) 0.72 rates (Hz) [0.0]
times (s) 0.81 rates (Hz) [0.0]
times (s) 0.9 rates (Hz) [0.0]
times (s) 0.99 rates (Hz) [0.0]
times (s) 1.08 rates (Hz) [0.0]
times (s) 1.17 rates (Hz) [0.0]
times (s) 1.26 rates (Hz) [0.0]
times (s) 1.35 rates (Hz) [0.0]
times (s) 1.44 rates (Hz) [0.0]
times (s) 1.53 rates (Hz) [0.0]
times (s) 1.62 rates (Hz) [0.0]
times (s) 1.71 rates (Hz) [0.0]
times (s) 1.8 rates (Hz) [0.0]
times (s) 1.89 rates (Hz) [0.0]
times (s) 1.98 rates (Hz) [0.0]
times (s) 2.07 rates (Hz) [0.0]
times (s) 2.16 rates (Hz) [0.0]
times (s) 2.25 rates (Hz) [0.0]
times (s) 2.34 rates (Hz) [0.0]
times (s) 2.43 rates (Hz) [0.0]
times (s) 2.52 rates (Hz) [0.0]
times (s) 2.61 rates (Hz) [0.0]
times (s) 2.7 rates (Hz) [0.0]
times (s) 2.79 rates (Hz) [0.0]
times (s) 2.88 rates (Hz) [0.0]
times (s) 2.97 rates (Hz) [0.0]
times (s) 3.06 rates (Hz) [0.0]
times (s) 3.15 rates (Hz) [0.0]
times (s) 3.24 rates (Hz) [0.0]
times (s) 3.33 rates (Hz) [0.0]
times (s) 3.42 rates (Hz) [0.0]
times (s) 3.51 rates (Hz) [0.0]
times (s) 3.6 rates (Hz) [0.0]
times (s) 3.69 rates (Hz) [0.0]
times (s) 3.78 rates (Hz) [0.0]
times (s) 3.87 rates (Hz) [0.0]
times (s) 3.96 rates (Hz) [0.0]
times (s) 4.05 rates (Hz) [0.0]
times (s) 4.14 rates (Hz) [0.0]
times (s) 4.23 rates (Hz) [0.0]
times (s) 4.32 rates (Hz) [0.0]
times (s) 4.41 rates (Hz) [0.0]
times (s) 4.5 rates (Hz) [0.0]
times (s) 4.59 rates (Hz) [0.0]
times (s) 4.68 rates (Hz) [0.0]
times (s) 4.77 rates (Hz) [0.0]
times (s) 4.86 rates (Hz) [0.0]
times (s) 4.95 rates (Hz) [0.0]
times (s) 5.05 rates (Hz) [0.0]
times (s) 5.14 rates (Hz) [0.0]
times (s) 5.23 rates (Hz) [0.0]
times (s) 5.32 rates (Hz) [0.0]
times (s) 5.41 rates (Hz) [0.0]
times (s) 5.5 rates (Hz) [0.0]
times (s) 5.59 rates (Hz) [0.0]
times (s) 5.68 rates (Hz) [0.0]
times (s) 5.77 rates (Hz) [0.0]
times (s) 5.86 rates (Hz) [0.0]
times (s) 5.95 rates (Hz) [0.0]
times (s) 6.04 rates (Hz) [0.0]
times (s) 6.13 rates (Hz) [0.0]
times (s) 6.22 rates (Hz) [0.0]
times (s) 6.31 rates (Hz) [0.0]
times (s) 6.4 rates (Hz) [0.0]
times (s) 6.49 rates (Hz) [0.0]
times (s) 6.58 rates (Hz) [0.0]
times (s) 6.67 rates (Hz) [0.0]
times (s) 6.76 rates (Hz) [0.0]
times (s) 6.85 rates (Hz) [0.0]
times (s) 6.94 rates (Hz) [0.0]
times (s) 7.03 rates (Hz) [0.0]
times (s) 7.12 rates (Hz) [0.0]
times (s) 7.21 rates (Hz) [0.0]
times (s) 7.3 rates (Hz) [0.0]
times (s) 7.39 rates (Hz) [0.0]
times (s) 7.48 rates (Hz) [0.0]
times (s) 7.57 rates (Hz) [0.0]
times (s) 7.66 rates (Hz) [0.0]
times (s) 7.75 rates (Hz) [0.0]
times (s) 7.84 rates (Hz) [0.0]
times (s) 7.93 rates (Hz) [0.0]
times (s) 8.02 rates (Hz) [0.0]
times (s) 8.11 rates (Hz) [0.0]
times (s) 8.2 rates (Hz) [0.0]
times (s) 8.29 rates (Hz) [0.0]
times (s) 8.38 rates (Hz) [0.0]
times (s) 8.47 rates (Hz) [0.0]
times (s) 8.56 rates (Hz) [0.0]
times (s) 8.65 rates (Hz) [0.0]
times (s) 8.74 rates (Hz) [0.0]
times (s) 8.83 rates (Hz) [0.0]
times (s) 8.92 rates (Hz) [0.0]
times (s) 9.01 rates (Hz) [0.0]
Elapsed (with compilation) = 0.591027139686048s
:END:

#+begin_src ipython
  print(rates.shape)
#+end_src

#+RESULTS:
:RESULTS:
torch.Size([40, 101, 1000])
:END:

#+begin_src ipython
  plt.imshow(rates[1].cpu().numpy().T, aspect='auto', origin='lower', vmax=1, cmap='jet')
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/8e1d1a824ab8bb8ba0d459a09a8e088d82763249.png]]
:END:

** 2 populations
*** Training

#+begin_src ipython
  theta_list = torch.linspace(0, 2.0 * torch.pi, model.Na[0] + 1)[:-1]

  Wfb = torch.stack((torch.cos(theta_list), torch.sin(theta_list)))
  Wfb = Wfb.to('cuda:1')
  print('Wfb:', Wfb.shape)

  N_TRAIN = 10
  A_psi = 1.0 # / torch.sqrt(model.Ka[0])
  psi_list = torch.linspace(0, 2.0 * torch.pi, N_TRAIN + 1)[:-1]

  z = torch.stack((torch.cos(psi_list), torch.sin(psi_list))).T
  z = A_psi * z.to('cuda:1')
  
  print('z:', z.shape)

  input_E = model.Ja0[0] * torch.sqrt(model.Ka[0]) * model.M0 + z @ Wfb
  print('input:', input_E.shape)

  # need to make the input a sequence
  input_E = input_E.unsqueeze(1).expand(input_E.shape[0], model.N_STEPS, input_E.shape[-1])
  print('reshaped input:', input_E.shape)

  # need to add inhibitory inputs
  N_I = model.N_NEURON - model.Na[0]
  input_I = torch.ones(input_E.size(0), input_E.size(1), N_I, device='cuda:1') * model.Ja0[1] * torch.sqrt(model.Ka[0]) * model.M0
  print(input_I.shape)

  ff_input = torch.cat((input_E, input_I), dim=-1)
  print('reshaped input:', ff_input.shape)
#+end_src

#+RESULTS:
:RESULTS:
Wfb: torch.Size([2, 10000])
z: torch.Size([10, 2])
input: torch.Size([10, 10000])
reshaped input: torch.Size([10, 4440, 10000])
# [goto error]
---------------------------------------------------------------------------
IndexError                                Traceback (most recent call last)
Cell In[162], line 25
     23 # need to add inhibitory inputs
     24 N_I = model.N_NEURON - model.Na[0]
---> 25 input_I = torch.ones(input_E.size(0), input_E.size(1), N_I, device='cuda:1') * model.Ja0[1] * torch.sqrt(model.Ka[0]) * model.M0
     26 print(input_I.shape)
     28 ff_input = torch.cat((input_E, input_I), dim=-1)

IndexError: index 1 is out of bounds for dimension 0 with size 1
:END:

#+begin_src ipython
  rates = model(ff_input, REC_LAST_ONLY=0)
#+end_src

#+RESULTS:
:RESULTS:
times (s) 0.0 rates (Hz) [2.65, 5.89]
times (s) 0.09 rates (Hz) [2.68, 5.86]
times (s) 0.18 rates (Hz) [2.69, 5.83]
times (s) 0.27 rates (Hz) [2.69, 5.83]
times (s) 0.36 rates (Hz) [2.75, 5.88]
times (s) 0.45 rates (Hz) [2.7, 5.83]
times (s) 0.54 rates (Hz) [2.69, 5.8]
times (s) 0.63 rates (Hz) [2.73, 5.88]
times (s) 0.72 rates (Hz) [2.71, 5.82]
times (s) 0.81 rates (Hz) [2.75, 5.89]
times (s) 0.9 rates (Hz) [2.73, 5.84]
times (s) 0.99 rates (Hz) [2.68, 5.78]
times (s) 1.08 rates (Hz) [2.69, 5.78]
times (s) 1.17 rates (Hz) [2.71, 5.82]
times (s) 1.26 rates (Hz) [2.69, 5.83]
times (s) 1.35 rates (Hz) [2.69, 5.84]
times (s) 1.44 rates (Hz) [2.78, 5.9]
times (s) 1.53 rates (Hz) [2.71, 5.84]
times (s) 1.62 rates (Hz) [2.71, 5.84]
times (s) 1.71 rates (Hz) [2.74, 5.86]
times (s) 1.8 rates (Hz) [2.72, 5.85]
times (s) 1.89 rates (Hz) [2.72, 5.84]
times (s) 1.98 rates (Hz) [2.74, 5.86]
times (s) 2.07 rates (Hz) [2.7, 5.85]
times (s) 2.16 rates (Hz) [2.67, 5.81]
times (s) 2.25 rates (Hz) [2.7, 5.81]
times (s) 2.34 rates (Hz) [2.71, 5.83]
times (s) 2.43 rates (Hz) [2.76, 5.88]
times (s) 2.52 rates (Hz) [2.68, 5.77]
times (s) 2.61 rates (Hz) [2.75, 5.86]
times (s) 2.7 rates (Hz) [2.72, 5.86]
times (s) 2.79 rates (Hz) [2.67, 5.78]
times (s) 2.88 rates (Hz) [2.7, 5.81]
times (s) 2.97 rates (Hz) [2.76, 5.88]
times (s) 3.06 rates (Hz) [2.76, 5.87]
times (s) 3.15 rates (Hz) [2.74, 5.88]
times (s) 3.24 rates (Hz) [2.72, 5.88]
times (s) 3.33 rates (Hz) [2.67, 5.81]
times (s) 3.42 rates (Hz) [2.68, 5.81]
times (s) 3.51 rates (Hz) [2.73, 5.84]
times (s) 3.6 rates (Hz) [2.75, 5.87]
times (s) 3.69 rates (Hz) [2.71, 5.86]
times (s) 3.78 rates (Hz) [2.76, 5.88]
times (s) 3.87 rates (Hz) [2.76, 5.89]
times (s) 3.96 rates (Hz) [2.74, 5.83]
times (s) 4.05 rates (Hz) [2.68, 5.8]
times (s) 4.14 rates (Hz) [2.71, 5.84]
times (s) 4.23 rates (Hz) [2.69, 5.82]
times (s) 4.32 rates (Hz) [2.71, 5.84]
times (s) 4.41 rates (Hz) [2.75, 5.83]
times (s) 4.5 rates (Hz) [2.73, 5.82]
times (s) 4.59 rates (Hz) [2.67, 5.77]
times (s) 4.68 rates (Hz) [2.7, 5.83]
times (s) 4.77 rates (Hz) [2.72, 5.86]
times (s) 4.86 rates (Hz) [2.75, 5.91]
times (s) 4.95 rates (Hz) [2.67, 5.8]
times (s) 5.05 rates (Hz) [2.69, 5.82]
times (s) 5.14 rates (Hz) [2.69, 5.84]
times (s) 5.23 rates (Hz) [2.67, 5.82]
times (s) 5.32 rates (Hz) [2.7, 5.82]
times (s) 5.41 rates (Hz) [2.69, 5.82]
times (s) 5.5 rates (Hz) [2.67, 5.8]
times (s) 5.59 rates (Hz) [2.7, 5.84]
times (s) 5.68 rates (Hz) [2.76, 5.86]
times (s) 5.77 rates (Hz) [2.74, 5.84]
times (s) 5.86 rates (Hz) [2.7, 5.77]
times (s) 5.95 rates (Hz) [2.74, 5.82]
times (s) 6.04 rates (Hz) [2.75, 5.88]
times (s) 6.13 rates (Hz) [2.72, 5.83]
times (s) 6.22 rates (Hz) [2.73, 5.84]
times (s) 6.31 rates (Hz) [2.75, 5.88]
times (s) 6.4 rates (Hz) [2.7, 5.84]
times (s) 6.49 rates (Hz) [2.65, 5.77]
times (s) 6.58 rates (Hz) [2.71, 5.81]
times (s) 6.67 rates (Hz) [2.71, 5.81]
times (s) 6.76 rates (Hz) [2.7, 5.82]
times (s) 6.85 rates (Hz) [2.7, 5.83]
times (s) 6.94 rates (Hz) [2.71, 5.84]
times (s) 7.03 rates (Hz) [2.68, 5.79]
times (s) 7.12 rates (Hz) [2.68, 5.79]
times (s) 7.21 rates (Hz) [2.7, 5.81]
times (s) 7.3 rates (Hz) [2.72, 5.86]
times (s) 7.39 rates (Hz) [2.73, 5.88]
times (s) 7.48 rates (Hz) [2.71, 5.84]
times (s) 7.57 rates (Hz) [2.68, 5.81]
times (s) 7.66 rates (Hz) [2.74, 5.9]
times (s) 7.75 rates (Hz) [2.71, 5.85]
times (s) 7.84 rates (Hz) [2.68, 5.79]
times (s) 7.93 rates (Hz) [2.75, 5.86]
times (s) 8.02 rates (Hz) [2.72, 5.83]
times (s) 8.11 rates (Hz) [2.72, 5.83]
times (s) 8.2 rates (Hz) [2.77, 5.9]
times (s) 8.29 rates (Hz) [2.75, 5.88]
times (s) 8.38 rates (Hz) [2.73, 5.86]
times (s) 8.47 rates (Hz) [2.74, 5.86]
times (s) 8.56 rates (Hz) [2.74, 5.87]
times (s) 8.65 rates (Hz) [2.76, 5.92]
times (s) 8.74 rates (Hz) [2.72, 5.86]
times (s) 8.83 rates (Hz) [2.73, 5.86]
times (s) 8.92 rates (Hz) [2.7, 5.86]
times (s) 9.01 rates (Hz) [2.71, 5.86]
Elapsed (with compilation) = 7.108553844504058s
:END:

#+begin_src ipython
  plt.imshow(rates[-3].cpu().numpy().T, aspect='auto', origin='lower', vmax=10, cmap='jet')
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/2025bdaed576de425e2ec9d19402dee5f4497512.png]]
:END:

#+begin_src ipython
  print(z.shape)
  theta = get_theta(z.T[0].cpu().numpy(), z.T[1].cpu().numpy(), GM=0, IF_NORM=0)
  idx = theta.argsort()
  print(theta.shape)
  rates_ord = rates[..., idx]
  print(rates_ord.shape)
#+end_src

#+RESULTS:
:RESULTS:
torch.Size([10, 2])
(10,)
torch.Size([10, 101, 10])
:END:

#+begin_src ipython
  plt.imshow(rates_ord[0].cpu().numpy().T, aspect='auto', origin='lower', vmax=10, cmap='jet')
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/2f693931759f4bf26f9fb6948c3df6fd568d1871.png]]
:END:

#+begin_src ipython
  print('rates:', rates.shape)
#+end_src

#+RESULTS:
:RESULTS:
rates: torch.Size([10, 101, 8000])
:END:

#+begin_src ipython
  # Wout = Phi @ Cinv @ zbar
  # where Phi are the steady state rates phi(theta_i, psi_m) (N x M)
  # Cinv is the correlations btw rates PhiT @ Phi (MxM)

  Phi = rates[:,-1].T
  Corr = Phi.T @ Phi
  print('Phi', Phi.shape, 'Corr', Corr.shape, 'z', z.shape)

  Wout = Phi @ Corr @ z
  print('Wout', Wout.shape)
  
  Wstruct = Wfb.T @ Wout.T
  print('W', Wstruct.shape)
#+end_src

#+RESULTS:
:RESULTS:
Phi torch.Size([8000, 10]) Corr torch.Size([10, 10]) z torch.Size([10, 2])
Wout torch.Size([8000, 2])
W torch.Size([8000, 8000])
:END:

#+begin_src ipython
  Cij = Wstruct.cpu().detach().numpy()
#+end_src

#+RESULTS:

#+begin_src ipython
  plt.figure(figsize=(12, 5))  # Set the figure size (width, height) in inches

  ax1 = plt.subplot2grid((2, 3), (0, 0), rowspan=2)
  im = ax1.imshow(Cij, cmap='jet', aspect=1)
  ax1.set_xlabel("Presynaptic")
  ax1.set_ylabel("Postsynaptic")

  # Second column, first row
  ax2 = plt.subplot2grid((2, 3), (0, 1))
  Kj = np.sum(Cij, axis=0)  # sum over pres
  ax2.plot(Kj)
  # ax2.set_xticklabels([])
  ax2.set_ylabel("$K_j$")

  # # Second column, second row
  ax3 = plt.subplot2grid((2, 3), (1, 1))
  Ki = np.sum(Cij, axis=1)  # sum over pres
  ax3.plot(Kj)
  ax3.set_ylabel("$K_i$")

  ax4 = plt.subplot2grid((2, 3), (0, 2), rowspan=2)
  diags = []
  for i in range(int(Cij.shape[0] / 2)):
      diags.append(np.trace(Cij, offset=i) / Cij.shape[0])
  diags = np.array(diags)
  ax4.plot(diags)
  ax4.set_xlabel("Neuron #")
  ax4.set_ylabel("$P_{ij}$")

  plt.tight_layout()
  plt.show()

#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/2354c1efced09ae2c4db8b4dac9f97cc81ffd4b0.png]]
:END:

*** Testing

#+begin_src ipython
  model.Wab_T[model.slices[0],model.slices[0]].add_(Wstruct.T);
#+end_src

#+RESULTS:

#+begin_src ipython
  rates = model()
#+end_src

#+RESULTS:
:RESULTS:
Generating ff input
times (s) 0.0 rates (Hz) [0.5, 0.68]
times (s) 0.09 rates (Hz) [0.5, 0.68]
times (s) 0.18 rates (Hz) [0.5, 0.68]
times (s) 0.27 rates (Hz) [0.5, 0.68]
times (s) 0.36 rates (Hz) [0.5, 0.68]
times (s) 0.45 rates (Hz) [0.5, 0.68]
times (s) 0.54 rates (Hz) [0.5, 0.68]
times (s) 0.63 rates (Hz) [0.5, 0.68]
times (s) 0.72 rates (Hz) [0.5, 0.68]
times (s) 0.81 rates (Hz) [0.5, 0.68]
times (s) 0.9 rates (Hz) [0.52, 0.73]
times (s) 0.99 rates (Hz) [0.68, 1.06]
times (s) 1.08 rates (Hz) [0.69, 1.06]
times (s) 1.17 rates (Hz) [0.69, 1.06]
times (s) 1.26 rates (Hz) [0.68, 1.06]
times (s) 1.35 rates (Hz) [0.68, 1.06]
times (s) 1.44 rates (Hz) [0.68, 1.06]
times (s) 1.53 rates (Hz) [0.68, 1.06]
times (s) 1.62 rates (Hz) [0.68, 1.06]
times (s) 1.71 rates (Hz) [0.68, 1.06]
times (s) 1.8 rates (Hz) [0.68, 1.06]
times (s) 1.89 rates (Hz) [0.68, 1.06]
times (s) 1.98 rates (Hz) [0.68, 1.06]
times (s) 2.07 rates (Hz) [0.68, 1.06]
times (s) 2.16 rates (Hz) [0.68, 1.06]
times (s) 2.25 rates (Hz) [0.68, 1.06]
times (s) 2.34 rates (Hz) [0.68, 1.06]
times (s) 2.43 rates (Hz) [0.68, 1.06]
times (s) 2.52 rates (Hz) [0.68, 1.06]
times (s) 2.61 rates (Hz) [0.68, 1.06]
times (s) 2.7 rates (Hz) [0.68, 1.06]
times (s) 2.79 rates (Hz) [0.68, 1.06]
times (s) 2.88 rates (Hz) [0.68, 1.06]
times (s) 2.97 rates (Hz) [0.68, 1.06]
times (s) 3.06 rates (Hz) [0.68, 1.06]
times (s) 3.15 rates (Hz) [0.68, 1.06]
times (s) 3.24 rates (Hz) [0.68, 1.06]
times (s) 3.33 rates (Hz) [0.68, 1.06]
times (s) 3.42 rates (Hz) [0.68, 1.06]
times (s) 3.51 rates (Hz) [0.68, 1.06]
times (s) 3.6 rates (Hz) [0.68, 1.06]
times (s) 3.69 rates (Hz) [0.68, 1.06]
times (s) 3.78 rates (Hz) [0.68, 1.06]
times (s) 3.87 rates (Hz) [0.68, 1.06]
times (s) 3.96 rates (Hz) [0.68, 1.06]
times (s) 4.05 rates (Hz) [0.68, 1.06]
times (s) 4.14 rates (Hz) [0.68, 1.06]
times (s) 4.23 rates (Hz) [0.68, 1.06]
times (s) 4.32 rates (Hz) [0.68, 1.06]
times (s) 4.41 rates (Hz) [0.68, 1.06]
times (s) 4.5 rates (Hz) [0.68, 1.06]
times (s) 4.59 rates (Hz) [0.68, 1.06]
times (s) 4.68 rates (Hz) [0.68, 1.06]
times (s) 4.77 rates (Hz) [0.68, 1.06]
times (s) 4.86 rates (Hz) [0.68, 1.06]
times (s) 4.95 rates (Hz) [0.68, 1.06]
times (s) 5.05 rates (Hz) [0.68, 1.06]
times (s) 5.14 rates (Hz) [0.68, 1.06]
times (s) 5.23 rates (Hz) [0.68, 1.06]
times (s) 5.32 rates (Hz) [0.68, 1.06]
times (s) 5.41 rates (Hz) [0.68, 1.06]
times (s) 5.5 rates (Hz) [0.68, 1.06]
times (s) 5.59 rates (Hz) [0.68, 1.06]
times (s) 5.68 rates (Hz) [0.68, 1.06]
times (s) 5.77 rates (Hz) [0.68, 1.06]
times (s) 5.86 rates (Hz) [0.68, 1.06]
times (s) 5.95 rates (Hz) [0.68, 1.06]
times (s) 6.04 rates (Hz) [0.68, 1.06]
times (s) 6.13 rates (Hz) [0.68, 1.06]
times (s) 6.22 rates (Hz) [0.68, 1.06]
times (s) 6.31 rates (Hz) [0.68, 1.06]
times (s) 6.4 rates (Hz) [0.68, 1.06]
times (s) 6.49 rates (Hz) [0.68, 1.06]
times (s) 6.58 rates (Hz) [0.68, 1.06]
times (s) 6.67 rates (Hz) [0.68, 1.06]
times (s) 6.76 rates (Hz) [0.68, 1.06]
times (s) 6.85 rates (Hz) [0.68, 1.06]
times (s) 6.94 rates (Hz) [0.68, 1.06]
times (s) 7.03 rates (Hz) [0.68, 1.06]
times (s) 7.12 rates (Hz) [0.68, 1.06]
times (s) 7.21 rates (Hz) [0.68, 1.06]
times (s) 7.3 rates (Hz) [0.68, 1.06]
times (s) 7.39 rates (Hz) [0.68, 1.06]
times (s) 7.48 rates (Hz) [0.68, 1.06]
times (s) 7.57 rates (Hz) [0.68, 1.06]
times (s) 7.66 rates (Hz) [0.68, 1.06]
times (s) 7.75 rates (Hz) [0.68, 1.06]
times (s) 7.84 rates (Hz) [0.68, 1.06]
times (s) 7.93 rates (Hz) [0.68, 1.06]
times (s) 8.02 rates (Hz) [0.68, 1.06]
times (s) 8.11 rates (Hz) [0.68, 1.06]
times (s) 8.2 rates (Hz) [0.68, 1.06]
times (s) 8.29 rates (Hz) [0.68, 1.06]
times (s) 8.38 rates (Hz) [0.68, 1.06]
times (s) 8.47 rates (Hz) [0.68, 1.06]
times (s) 8.56 rates (Hz) [0.68, 1.06]
times (s) 8.65 rates (Hz) [0.68, 1.06]
times (s) 8.74 rates (Hz) [0.68, 1.06]
times (s) 8.83 rates (Hz) [0.68, 1.06]
times (s) 8.92 rates (Hz) [0.68, 1.06]
times (s) 9.01 rates (Hz) [0.68, 1.06]
Elapsed (with compilation) = 7.225121513009071s
:END:

#+begin_src ipython
  print(rates.shape)
#+end_src

#+RESULTS:
:RESULTS:
torch.Size([10, 101, 8000])
:END:

#+begin_src ipython
  plt.imshow(rates[0].cpu().numpy().T, aspect='auto', origin='lower', vmax=10, cmap='jet')
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/9ae5007223d0dafb6957fe1df889910595758bbe.png]]
:END:
